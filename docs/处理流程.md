

## 模型预处理
### 总览

渲染器需要用到的文件共 10 个，分别为：
* 1 个模型信息文件：`model_info.json`[$^3$](#modelinfo)
* 5 个几何数据文件：`*_ctrl.bin, *_geom.bin,*_trim.bin,*_samp.bin, *_flag.bin`
* 4 个 trimming 数据文件：`*_roots.bin, *_tree.bin,*_curveset.bin,*_curvedetail.bin`

从 3DM 文件开始，分三步生成。


### step 1: zengyajun/trimming_processor
将 3MD 文件中的曲面曲线信息提取出来。
* 仓库：http://114.116.27.134:3000/zengyajun/trimming_processor.git 
* 程序：master : `/opennurbstest/`
* 依赖：
    * OpenNURBS 7.x   
    * nlohmann-json
* 输入：3DM 文件
* 输出：`model_info.json` 及中间数据：`patch_info.txt, patch_info_offset.txt`，模型的曲面曲线信息。
* 使用：设置配置文件`/opennurbstest/control_parameters.json`[$^1$](#opennurbs_config)后运行程序
* 注意事项:
    * 3 个输出文件被放在输出路径下与模型文件同名文件夹中;

### step 2: zhujiaming/NurbsViwer: 
主要的预处理过程。
* 仓库：http://114.116.27.134:3000/zhujiaming/NurbsViwer.git
* 程序：developing: `/Projects/Trimming/`
* 依赖：
    * OpenCacade 7.8.0
    * VLD, 似乎可以直接去掉
    * nlohmann-json
    * Eigen
    * stb-image
* 输入：`model_info.json, patch_info.txt, patch_info_offset.txt`
* 输出：除 `*_samp.bin` 外的渲染所需文件
* 使用：设置配置文件`/Projects/Trimming/config.json` [$^2$](#trimming)后运行程序
* 注意事项:
    * 运行时设置的文件名实际上是上一步预处理 (`zengyajun/trimming_processor`)生成的与模型文件同名的文件夹;
    * 错误代码见 [Error Code](#TrimmingError), 除 `std::runtime_error` 外, 出错的 NURBS 曲面预处理终止. 若 NURBS 曲面几何数据正确, 去掉 Trimming Curve, 作为 totally untrimmed 曲面输出; 若 NURBS 曲面几何数据错误, 忽略该曲面;
    * `config.json` 文件位置不能变动，若要编译成 exe 程序，需修改代码，或在程序所在目录创建文件夹 `/Trimming/`, 将`config.json` 放入其中;
    * 输出文件被默认放在与输入文件相同的文件夹, 详情见[生成模式](#generate);
    * 最新版本不再需要先解析再合并, 运行一次即可.

### step 3: xiongruicheng/CUDA_MESHLET: developing_trim : BezierPreProcess 
生成 `*_samp.bin` 文件。
* 仓库：http://114.116.27.134:3000/xiongruicheng/CUDA_MESHLET.git
* 程序：developing_trim: `/BezierPreProcess/`
* 依赖：
    * CUDA 11.8 
* 输入：`*_ctrl.bin, *_geom.bin, *_flag.bin`
* 输出：`*_samp.bin`
* 使用：在 `/BezierPreProcess/main.cpp` 中设置输入输出的文件路径与文件名后编译运行
* 注意事项:
    * 有时 Realease 模式运行会卡死，切换 Debug 即可.


### 附录

#### <h2 id = "opennurbs_config"> control_parameters.json 配置(部分) </h2>

| 项 | 类型 | 默认值 | 说明 |
| --- | --- | --- | --- |
| GEOMETRY_SHRINK | float |0.1| 模型缩放尺寸，目前为了渲染，模型尺寸是缩小的 |
| MODEL_NAME | string | - | 模型文件名（不包含拓展名且必须为 3dm） |
| INPUT_MODEL_PATH | string | "D:/model/" | 输入路径 |
| OUTPUT_ROOT | string | "D:/model/" | 输出路径 |


#### <h2 id = "trimming"> config.json 配置 </h2>

| 项 | 类型 | 默认值 | 说明 |
| --- | --- | --- | --- |
| Model | [string,string]|["D:\\\\model\\\\","your_model"]| 模型文件的路径和文件名（不包含拓展名且必须为 3dm）|
| Render | 根对象 | - | 渲染器配置，目前不起作用|
| Test | 根对象 | - | 渲染测试配置，目前不起作用|
| Trimming | 根对象 | - | 剪裁预处理配置 |
| -BezierWise | int | 1 | 输出数据是否以 Bezier 曲面为单位 |
| -Enable | int | 1 | 是否开启 Trimming 功能 |
| -EvalMethod | string | "ls" | Trimming Test 的 [ray-curve-intersection 策略](#ray-curve)|
| -SearchMethod | string | "gridbsp" | Trimming Test 的[建树策略](#tree) |
| -GenerateMode | int | 0 | 预处理程序的[生成模式](#generate) |
| -OnlyTree | int | 0 | 测试用选项，是否只生成搜索树 |
| -PatchPerFolder | int | 1000 | 多少张 NURBS 曲面的预处理中间文件放入一个文件夹 |
| -Preproccess | 根对象 | - | 预处理程序运行参数 |
| --DebugStartFrom | int | 0 | 仅 Debug 模式，从第几个 NURBS 曲面开始预处理 |
| --SkipExisting | int | 1 | 仅 Release 模式，是否跳过已生成中间文件的 NURBS 曲面|
| --ThreadWaitTime | int | 500 | 仅 Release 模式，单个线程处理单张 NURBS 曲面的最大处理时间，超出时终止并重新启动线程 |
| --WorkerThreadCnt | int | 8 | 仅 Release 模式，预处理同时启动的线程数|

##### <h2 id = "ray-curve"> ray-curve-intersection 策略 </h2>
* "bin": 二分演算, [Schollmeyer09](https://doi.org/10.1145/1531326.1531353);
* "ls": 线性采样.

##### <h2 id = "tree"> 建树策略  </h2>
* "bsp": projection-driven BSP, 渲染代码未适配且无法正确输出渲染文件;
* "gridbsp";
* "kd": [Schollmeyer18](https://doi.org/10.1109/TVCG.2018.2814987);
* "optkd": 简单优化的 KD 树, [Sloup21](https://doi.org/10.1111/cgf.14410);
* "quad": 四叉树 [Claux12](https://doi.org/10.2312/PE/VMV/VMV12/031-038), 渲染代码未适配且无法正确输出渲染文件, 无法正确绘制 Trimming Texture.

##### <h2 id = "generate"> 生成模式  </h2>
+ 0 RenderDataBin, 渲染所需的二进制文件;
+ 1 RenderDataTxt, 渲染所需的文件 TXT 版，用于 Debug;
+ 2 Image, 图片版 Trimming Texture;
+ 3 TreeDepth, 计算所有曲面的搜索树高度的各种统计量;
+ 4 TextureBin, 二进制版 Trimming Texture;
+ 5 TextureTxt, txt 版 Trimming Texture;
+ 6 FacePerBezier, 以 Bezier 为单位演算曲面, 格式为 vetex + index;
+ 7 FacePerNurbsIndex, 以 NURBS 为单位演算曲面, 格式为 vetex + index;
+ 8 FacePerNurbsMatrix, 以 NURBS 为单位演算曲面, 格式为 vetex 矩阵;
+ 9 Cut, 演算所有 Trimming Curve, 并给出所有树结构的分割线.

0, 1 的中间文件及其它生成模式的的输出均被放入 [model_info.json](#modelinfo) 中设置的 Trimming: Output. 使用 0, 1 生成后需手动删除中间文件.

#### <h2 id = "modelinfo"> model_info.json  </h2>

内容一般不需要修改，可能引起未知错误。

| 项 | 类型 | 默认值 | 说明 |
| --- | --- | --- | --- |
| Geometry | 根对象 |-| 模型几何信息 |
| -BezierNum | int | - | Bezier 曲面总数 |
| -TrimmedBezierNum | int | - | 被剪裁的 Bezier 曲面数 |
| -BoundingBox | "max":[float,float,float],"min":[float,float,float]| - | 整个模型的 Bounding Box |
| -OriginFile | string | - | 原始模型文件相对路径 |
| -Ctrl | string | - | ctrl 文件相对路径 |
| -Flag | string | - | flag 文件相对路径 |
| -Geom | string | - | geom 文件相对路径 |
| -Samp | string | - | samp 文件相对路径 |
| -Trim | string | - | trim 文件相对路径 |
| Type | string | "Nurbs" | 输入文件的曲面与曲线格式，目前不支持修改 |
| HasTrim | int | 1 | 是否开启 Trimming |
| LatestErrorPatch | int | - | 最后一个报错的曲面 ID |
| Name | string | - | 模型名 |
| PatchNum | int | - | 输入文件 NURBS 曲面总数 |
| ProcessedPatch | int | - | 已处理的 NURBS 曲面总数，包含已处理的错误曲面 |
| MergedPatchNum | int | - | 预处理完成合并的曲面数，不包含已处理的错误曲面 |
| ReadMode | string | "TXT" | 输入文件格式，此外可选 "BIN", 但上游预处理代码没做适配 |
| Trimming | 根对象 | - | 模型 Trimming 信息 |
| -Roots | int | string | root 文件相对路径 |
| -Roots_Size | int | - | root 文件大小 |
| -Tree | string | - | tree 文件相对路径 |
| -Tree_Size | int | - | tree 文件大小 |
| -CurveSet | string | - | curveset 文件相对路径 |
| -CurveSet_Size | int | - | curveset 文件大小 |
| -CurveDetail | string | - | curvedetail 文件相对路径 |
| -CurveDetail_Size | int | - | curvedetail 文件大小 |
| -CurveDetail_Type | string | "FS" | 未知, 似乎没起作用 |
| -Domain | string | - | domain 文件相对路径 |
| -File | string | "patch_info.txt" | 输入文件曲面曲线数据 |
| -OffsetTable | string | "patch_info_offset.txt" | 输入文件 offset 信息 |
| -GenerateMode | int | 0 | 预处理程序的生成类型。无效，已被移入 [config.json](#trimming) |
| -MaxBezierOrder | int | - | 最大 Bezier 曲线阶数 |
| -ResolveDone | int | - | 是否已生成全部中间数据 |
| -MergeDone | int | - | 是否完成文件合并，即全部预处理 |
| -Output | string | "/result/" | 中间文件的输出路径 |
| -Skip | [int,...] | [] | 跳过不处理的 NURBS 曲面 ID |
| -RuntimeSetting | 根对象 | - | 运行时配置。无效，已被移入 [config.json](#trimming) |

#### <h2 id = "TrimmingError"> 错误代码  </h2>

* `0` 未归类错误, 只抛出异常信息没有其它输出.
    * `"wrong face!"` 曲面数据错误，曲面的节点重数，节点数，阶数不匹配;
    * `"Unexcepted node type!"` 没有子节点的节点未被正确标记为 Culling 或 Leaf;
    * `"unknown curve type!` 未定义的输入曲线类型;
    * `a regular curve degenerated."` 一个几何尺寸大于阈值的曲线因未知原因退化为了一个点.
* `1` 节点出错, Debug 模式下输出当前出错节点的曲线，分割，边界.
    * `"over height!"` 树高度超过预设值, 通常是由于计算误差，计算最优分割阶段预计会被分离的曲线段在实际的分割阶段未被分开, 导致无限重复的无效分割;
* `2` 曲线集错误，输出出错曲线集合的全体曲线. 未实际使用.
* `3` 曲线片段出错，Debug 模式下输出出错的曲线片段.
    * `"No mono direction!"` 被标记为单调的曲线片段不单调;
    * `"Infinite iteration!"` 求曲线与竖直或水平直线的交点时, 迭代无法终止, 通常是由曲线片段单调性判断错误引起的;
    * `"suburves cannot be departed!"` 两条单调曲线片段无法被水平射线区分开, 通常由于输入文件中存在两条完全重合的曲线;
* `4` 节点划分出错, Debug 模式下输出当前出错节点的曲线，分割，边界. 未实际使用.

* `std::runtime_error`. 程序终止, 若希望忽略这些错误, 改为抛出 `class lf_exception: public std::exception;`
    * `"Erro: failed to find the intesets point!"` 求出的曲线与直线交点偏离预期位置超过阈值;
    * `"Convert ro Bezier Patch Failed!"` 因输入数据错误, 未能正确地将 NURBS 曲面转换为 Bezier 形式;
    * `"Undedined evaluate method!"` ray-curve-intersection 策略填写错误;
    * `"Undedined search method!"` 建树策略填写错误;
    * `"Error: Failed to open model file!"` 文件名与路径格式填写错误;
    * `"Error: Curve::act_rangeCheck"` 试图创建或访问一条参数范围错误的曲线或曲线片段;
    * `"Erro: Nurbs::get_delta"` 进行曲线演算时指定的参数范围错误.